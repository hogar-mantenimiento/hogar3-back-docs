"use strict";(globalThis.webpackChunkhogar_3_back_docs=globalThis.webpackChunkhogar_3_back_docs||[]).push([[8670],{5352:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>d,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Protocolos/crear-proceso-intermodular","title":"Crear Proceso Intermodular","description":"El dise\xf1o semi-modular del backend puede colisionar con la necesidad de implementar funcionalidades (features) que requieran la cooperaci\xf3n y datos de m\xe1s de un m\xf3dulo simult\xe1neamente (m\xe1s all\xe1 de una simple relaci\xf3n de base de datos). Para comunicar una tarea entre m\xf3dulos de manera segura y as\xedncrona, y poder devolver una respuesta consolidada al cliente, se utiliza el ListenerBetweenModules, conocido informalmente como \\"globito\\".","source":"@site/docs/Protocolos/crear-proceso-intermodular.md","sourceDirName":"Protocolos","slug":"/Protocolos/crear-proceso-intermodular","permalink":"/hogar3-back-docs/docs/Protocolos/crear-proceso-intermodular","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Protocolos/crear-proceso-intermodular.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Crear un M\xf3dulo","permalink":"/hogar3-back-docs/docs/Protocolos/crear-modulo"}}');var o=r(4848),a=r(8453);const l={sidebar_position:2},d="Crear Proceso Intermodular",i={},c=[{value:"Paso 1: Analizar el Objetivo y Crear Listeners",id:"paso-1-analizar-el-objetivo-y-crear-listeners",level:3},{value:"Ejemplo de Listener",id:"ejemplo-de-listener",level:4},{value:"Manejo de Excepciones",id:"manejo-de-excepciones",level:4},{value:"Paso 2: Crear el Proceso (<code>CreateQueueEvent</code>)",id:"paso-2-crear-el-proceso-createqueueevent",level:3},{value:"<code>data: T</code>",id:"data-t",level:4},{value:"<code>res: Express.Response</code>",id:"res-expressresponse",level:4},{value:"<code>returnEvent: (payload) =&gt; void</code>",id:"returnevent-payload--void",level:4},{value:"<code>acts: (string | Function)[]</code>",id:"acts-string--function",level:4},{value:"Paso 3: Ejecutar",id:"paso-3-ejecutar",level:3},{value:"Ejemplo de Uso Completo",id:"ejemplo-de-uso-completo",level:4}];function t(e){const n={blockquote:"blockquote",code:"code",em:"em",h1:"h1",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"crear-proceso-intermodular",children:"Crear Proceso Intermodular"})}),"\n",(0,o.jsxs)(n.p,{children:["El dise\xf1o semi-modular del ",(0,o.jsx)(n.em,{children:"backend"})," puede colisionar con la necesidad de implementar funcionalidades (",(0,o.jsx)(n.em,{children:"features"}),") que requieran la cooperaci\xf3n y datos de ",(0,o.jsx)(n.strong,{children:"m\xe1s de un m\xf3dulo"})," simult\xe1neamente (m\xe1s all\xe1 de una simple relaci\xf3n de base de datos). Para comunicar una tarea entre m\xf3dulos de manera segura y ",(0,o.jsx)(n.strong,{children:"as\xedncrona"}),", y poder devolver una respuesta consolidada al cliente, se utiliza el ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"ListenerBetweenModules"})}),", conocido informalmente como ",(0,o.jsx)(n.strong,{children:'"globito"'}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Este mecanismo tiene la capacidad de viajar entre m\xf3dulos sin romper el dise\xf1o modular del sistema."}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"paso-1-analizar-el-objetivo-y-crear-listeners",children:"Paso 1: Analizar el Objetivo y Crear Listeners"}),"\n",(0,o.jsxs)(n.p,{children:["Lo primero es definir todos los m\xf3dulos y tareas que ser\xe1n parte de la ",(0,o.jsx)(n.em,{children:"feature"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["En los ",(0,o.jsx)(n.em,{children:"listeners"})," de los m\xf3dulos involucrados (o en archivos ",(0,o.jsx)(n.em,{children:"service"})," que los contengan), se deben crear funciones marcadas con el decorador ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"@OnEvent()"})})," de NestJS."]}),"\n",(0,o.jsxs)(n.p,{children:["Cada ",(0,o.jsx)(n.em,{children:"listener"})," debe aceptar un \xfanico par\xe1metro tipado como ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"ListenerBetweenModules<T>"})}),", donde ",(0,o.jsx)(n.code,{children:"T"})," es el gen\xe9rico que representa la estructura de datos que viaja. Este gen\xe9rico (",(0,o.jsx)(n.code,{children:"T"}),") debe definirse en el m\xf3dulo padre que inicia el proceso o en ",(0,o.jsx)(n.code,{children:"common"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Un punto crucial es que, al finalizar su l\xf3gica, cada ",(0,o.jsx)(n.em,{children:"listener"})," ",(0,o.jsx)(n.strong,{children:"debe llamar"})," a ",(0,o.jsx)(n.code,{children:"payload.next()"})," para avanzar a la siguiente etapa del proceso."]}),"\n",(0,o.jsxs)(n.p,{children:["La informaci\xf3n que se desea pasar entre las etapas debe guardarse dentro del campo ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:".data"})})," del ",(0,o.jsx)(n.em,{children:"payload"})," (",(0,o.jsx)(n.code,{children:"globito"}),")."]}),"\n",(0,o.jsx)(n.h4,{id:"ejemplo-de-listener",children:"Ejemplo de Listener"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'export class XListenerModule{\n\n  @OnEvent("proceso.por.aca.pasa")\n  async functionListener<T>(payload: ListenerBetweenModules<T>){\n    // L\xf3gica interna que manipula payload.data\n    // ...\n    payload.next() // Llama a la siguiente acci\xf3n en la cola\n  }\n\n}\n'})}),"\n",(0,o.jsx)(n.h4,{id:"manejo-de-excepciones",children:"Manejo de Excepciones"}),"\n",(0,o.jsxs)(n.p,{children:["Para las excepciones, el ",(0,o.jsx)(n.code,{children:"payload"})," trae un ",(0,o.jsx)(n.em,{children:"handler"})," de errores integrado (",(0,o.jsx)(n.code,{children:"handleError"}),")."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'export class XListenerModule{\n\n  @OnEvent("proceso.por.aca.pasa")\n  async functionListener<T>(payload: ListenerBetweenModules<T>){\n    try {\n      // l\xf3gica interna\n      payload.next()\n    } catch (error) {\n      payload.handleError(error) // Maneja y finaliza el proceso con el error\n    }\n  }\n\n}\n'})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Nota:"})," Este ",(0,o.jsx)(n.code,{children:"handleError"})," interno utiliza el m\xe9todo ",(0,o.jsx)(n.code,{children:"CommonService->HandleErrorManual"}),", por lo que sus respuestas son los est\xe1ndares definidos en el ",(0,o.jsx)(n.em,{children:"handleError"})," de la aplicaci\xf3n."]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsxs)(n.h3,{id:"paso-2-crear-el-proceso-createqueueevent",children:["Paso 2: Crear el Proceso (",(0,o.jsx)(n.code,{children:"CreateQueueEvent"}),")"]}),"\n",(0,o.jsx)(n.p,{children:"El servicio que dispare el proceso debe considerar:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Response:"})," El m\xe9todo debe recibir un objeto ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"Express.Response"})})," (generalmente como par\xe1metro) para manejar manualmente las respuestas del ",(0,o.jsx)(n.em,{children:"endpoint"}),', ya que el "globito" lo requiere para su respuesta final.']}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Creaci\xf3n:"})," El proceso se crea utilizando la funci\xf3n ",(0,o.jsx)(n.code,{children:"CreateQueueEvent()"})," proveniente de ",(0,o.jsx)(n.code,{children:"CommonModule"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Esta funci\xf3n requiere un objeto de configuraci\xf3n con los siguientes campos:"}),"\n",(0,o.jsx)(n.h4,{id:"data-t",children:(0,o.jsx)(n.code,{children:"data: T"})}),"\n",(0,o.jsxs)(n.p,{children:["El objeto base que contiene la ",(0,o.jsx)(n.strong,{children:"memoria"})," de lo que requiere el ",(0,o.jsx)(n.em,{children:"globito"})," en todas sus instancias. Tambi\xe9n es el tipado final que se espera en la respuesta."]}),"\n",(0,o.jsx)(n.h4,{id:"res-expressresponse",children:(0,o.jsx)(n.code,{children:"res: Express.Response"})}),"\n",(0,o.jsxs)(n.p,{children:["El objeto ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"Express.Response"})})," que ser\xe1 usado para enviar la respuesta HTTP final al cliente."]}),"\n",(0,o.jsx)(n.h4,{id:"returnevent-payload--void",children:(0,o.jsx)(n.code,{children:"returnEvent: (payload) => void"})}),"\n",(0,o.jsxs)(n.p,{children:["La funci\xf3n final que debe ser la encargada de hacer el ",(0,o.jsx)(n.code,{children:"return"})," utilizando el objeto ",(0,o.jsx)(n.code,{children:"res"})," para enviar la respuesta consolidada del proceso (",(0,o.jsx)(n.code,{children:"payload.data"}),"). Puede ser una ",(0,o.jsx)(n.strong,{children:"funci\xf3n flecha"})," o un ",(0,o.jsx)(n.strong,{children:"listener"}),", seg\xfan convenga."]}),"\n",(0,o.jsx)(n.h4,{id:"acts-string--function",children:(0,o.jsx)(n.code,{children:"acts: (string | Function)[]"})}),"\n",(0,o.jsxs)(n.p,{children:["La parte m\xe1s importante del ",(0,o.jsx)(n.em,{children:"globito"}),". Es un ",(0,o.jsx)(n.em,{children:"array"})," de ",(0,o.jsx)(n.strong,{children:"strings"})," o ",(0,o.jsx)(n.strong,{children:"funciones flecha"})," que se ejecutar\xe1n en orden (de arriba a abajo):"]}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{style:{textAlign:"left"},children:"Tipo de Acci\xf3n"}),(0,o.jsx)(n.th,{style:{textAlign:"left"},children:"Descripci\xf3n"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{style:{textAlign:"left"},children:(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"string"})})}),(0,o.jsxs)(n.td,{style:{textAlign:"left"},children:["Se utiliza para llamar a los ",(0,o.jsx)(n.em,{children:"listeners"})," creados en el Paso 1 (mediante el ",(0,o.jsx)(n.em,{children:"string"})," del evento ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"@OnEvent()"})}),")."]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{style:{textAlign:"left"},children:(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"Function (flecha)"})})}),(0,o.jsxs)(n.td,{style:{textAlign:"left"},children:["Simplifican el trabajo. Su fin es realizar tareas en el proceso que no requieran estar en otros m\xf3dulos. ",(0,o.jsx)(n.strong,{children:"Mantienen el contexto y las referencias"})," en memoria del m\xe9todo que cre\xf3 el ",(0,o.jsx)(n.code,{children:"QueueEvent"}),"."]})]})]})]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"paso-3-ejecutar",children:"Paso 3: Ejecutar"}),"\n",(0,o.jsxs)(n.p,{children:["Una vez creado el flujo en una constante, se debe usar el m\xe9todo ",(0,o.jsx)(n.code,{children:".next()"})," para iniciar el procesamiento."]}),"\n",(0,o.jsx)(n.h4,{id:"ejemplo-de-uso-completo",children:"Ejemplo de Uso Completo"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:'title="O.service.ts"',children:'import { Response } from \'express\';\n\nexport class OService {\n\n  constructor(\n    private readonly common: CommonService,\n  ){}\n\n  FeatureMultiModule(res: Response){\n    const QueueEvent = this.common.CreateQueueEvent({\n      data: {\n        // informaci\xf3n inicial del data (memoria)\n      },\n      returnEvent: (payload) => {\n        // Env\xeda la respuesta final al cliente\n        payload.res.status(200).send(payload.data)\n      },\n      res,\n      acts: [\n        "listener.primer.paso", // Llama a un listener en otro m\xf3dulo\n        (payload) => { // L\xf3gica local (por ejemplo, validaci\xf3n)\n          try {\n            // l\xf3gica local\n            payload.data.resultadoLocal = true;\n            payload.next()\n          } catch (error) {\n            payload.handleError(error)\n          }\n        },\n        "listener.paso.final", // Llama al \xfaltimo listener\n      ],\n    })\n    \n    // Inicia el flujo del proceso\n    QueueEvent.next()\n  }\n\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(t,{...e})}):t(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>d});var s=r(6540);const o={},a=s.createContext(o);function l(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);